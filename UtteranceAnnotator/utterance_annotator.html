<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Utterance Annotator</title>
	<link rel="stylesheet" href="utterance_annotator.css"/>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/themes/smoothness/jquery-ui.css"/>
	<link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
	<script src="https://cdn.rawgit.com/eligrey/Blob.js/0cef2746414269b16834878a8abc52eb9d53e6bd/Blob.js"></script>
	<script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
	<script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
	<script src="./utterance.js"></script>
	
	<script>
	function onBodyLoaded() {
		console.log('onBodyLoaded');
		var slot = localStorage.getItem('slot');
		if (slot != null) {
			contextMenuForSlot.items = Slot.parseSlotData(slot);
			$('#slotDataLoadButton').removeClass('unsatisfied');
			$('#slotDataLoadButton').addClass('satisfied');
		}
		
		var intent = localStorage.getItem('intent');
		if (intent != null) {
			contextMenuForIntent.items = Intent.parseIntentData(intent);
			$('#intentDataLoadButton').removeClass('unsatisfied');
			$('#intentDataLoadButton').addClass('satisfied');
		}
		
		var utterances = localStorage.getItem('utterances');
		if (utterances != null) {
			var items = Utterance.importFromCSV(utterances);
			for (var i = 0; i < items.length; ++i) {
				addListItem(items[i]['raw'], items[i]['tagged']);
			}
		} else {
			addListItem();
		}
	}

	function onBodyUnloaded() {
		console.log('onBodyUnloaded');
		var utterances = [];
		var items = $('#selectable')[0].children;
		for (var i = 0; i < items.length; ++i) {
			var raw = items[i].children[0].innerText;
			var tagged = items[i].children[1].innerText;
			utterances.push({
				'raw' : raw,
				'tagged' : tagged
			})
		}

		var csv = Utterance.exportToCSV(utterances);
		localStorage.setItem('utterances', csv);
	}
	
	var contextMenuForSlot = {
		items: {},
		callback: function(itemKey, opt) {
			var input = opt.$trigger[0];
			var index = getSelectionStart(input);
			if (index > 0) {
				for (; index >= 0; --index) {
					if (input.value.charAt(index - 1) == ' ') {
						break;
					}
				}
			}
			
			var startIdx = -1, endIdx = -1;				
			for (; index < input.value.length; ++index) {
				if (input.value.charAt(index) == ' ' || input.value.charAt(index) == ')') {
					if (startIdx == -1) startIdx = index;
					endIdx = index;
					break;
				} else if (input.value.charAt(index) == '/') {
					startIdx = index;
				}
			}
			
			if (startIdx == -1) startIdx = index;
			if (endIdx == -1) endIdx = index;
			
			input.value = insertString(input.value, startIdx, endIdx, '/' + itemKey);
			input.oninput(input);

			return true;
		}
	};

	var contextMenuForIntent = {
		items: {},
		callback: function(itemKey, opt) {
			var input = opt.$trigger[0];
			var text = input.value.substring(input.selectionStart, input.selectionEnd).trim();
		
			input.value = insertString(input.value, input.selectionStart, input.selectionEnd, '(' + text + ')' + itemKey);
			input.oninput(input);
			
			return true;
		}
	};

	$(function() {
        $.contextMenu({
            selector: '.context-menu-one',
			build: function($triggerElement, e) {
				var input = $triggerElement[0];
				var text = $triggerElement.val().substring(input.selectionStart, input.selectionEnd).trim();
				if (text == '') return contextMenuForSlot;
				else return contextMenuForIntent;
			},
        });
    });

	$(function() {
		$('#selectable').selectable({
			stop: function() {
				$('.ui-selected', this).each(function() {
					$('#inputRaw').val(this.children[0].innerText);
					$('#inputTagged').val(this.children[1].innerText);
					$('#inputRaw')[0].focus();
				});
			}
		});
	});

	function onRawInputChanged(input) {
		$('#selectable .ui-selected')[0].children[0].innerText = input.value;
	}

	function onTaggedInputChanged(input) {
		$('#selectable .ui-selected')[0].children[1].innerText = input.value;
	}
	
	function onSlotFileUploaded(input) {
		var file = input.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
			contextMenuForSlot.items = Slot.parseSlotData(reader.result);

			localStorage.setItem('slot', reader.result);
			$('#slotDataLoadButton').removeClass('unsatisfied');
			$('#slotDataLoadButton').addClass('satisfied');
		}

		reader.readAsText(file);
		input.value = null;
	}

	function onIntentFileUploaded(input) {
		var file = input.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
			contextMenuForIntent.items = Intent.parseIntentData(reader.result);
			
			localStorage.setItem('intent', reader.result);
			$('#intentDataLoadButton').removeClass('unsatisfied');
			$('#intentDataLoadButton').addClass('satisfied');
		}

		reader.readAsText(file);
		input.value = null;
	}

	function insertString(text, headIdx, tailIdx, str) {
		var head = text.substring(0, headIdx);
		var tail = text.substring(tailIdx);
		return head + str + tail;
	};
	
	function getSelectionStart(input) {
		if (input.createTextRange) {
			var r = document.selection.createRange().duplicate();
			r.moveEnd('character', input.value.length);
			if (r.text == '') return input.value.length;
			return input.value.lastIndexOf(r.text);
		} else {
			return input.selectionStart;
		}
	}
	
	function addListItem(raw, tagged) {
		console.log(raw + ', ' + tagged);
		if (raw == null) raw = '';
		if (tagged == null) tagged = '';
		$('#selectable').append('<li class="ui-widget-content"><span class="list-item-raw">' + raw + '</span><span class="list-item-tagged">' + tagged + '</span></li>');
	}
	
	function deleteAllItems() {
		var result = window.confirm('Delete all data?');
		if (result) {
			$('#selectable li').remove();
			addListItem();
		}
	}

	function onUntteranceDataImported(input) {
		var file = input.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
			var utterances = Utterance.importFromCSV(reader.result);
			for (var i = 0; i < utterances.length; ++i) {
				addListItem(utterances[i]['raw'], utterances[i]['tagged']);
			}
		}

		reader.readAsText(file, 'euc-kr');
		input.value = null;
	}

	function exportUtteranceData() {
		var utterances = [];
		var items = $('#selectable')[0].children;
		for (var i = 0; i < items.length; ++i) {
			var raw = items[i].children[0].innerText;
			var tagged = items[i].children[1].innerText;
			utterances.push({
				'raw' : raw,
				'tagged' : tagged
			})
		}

		var csv = Utterance.exportToCSV(utterances);
		var file = new File([csv], '', { type: "text/plain;charset=utf-8" });
		saveAs(file, 'utterance_data.csv');
	}
	
	function triggerClickEvent(id) {
		$('#' + id)[0].click();
	}
	
	</script>
</head>

<body onload="onBodyLoaded()" onunload="onBodyUnloaded()">
	<input type="file" class="hide" id="slotDataInput" onchange="onSlotFileUploaded(this)"/>
	<input type="file" class="hide" id="intentDataInput" onchange="onIntentFileUploaded(this)"/>
	<input type="file" class="hide" id="inputImport" onchange="onUntteranceDataImported(this)"/>

	<div id="headerArea" class="center">
		<h1 id="title">Utterance Annotator</h1>
		
		<div id="inputArea">
			<input type="text" id="inputRaw" oninput="onRawInputChanged(this)" placeholder="Input an utterance"/><br/>
			<input type="text" id="inputTagged" class="context-menu-one" placeholder="Annotate an utterance with tag" oninput="onTaggedInputChanged(this)"/>

		</div>
		
		<div id="annotationDataControlArea">
			<button id="slotDataLoadButton" class="unsatisfied" onclick="triggerClickEvent('slotDataInput')">Slot</button>
			<button id="intentDataLoadButton" class="unsatisfied" onclick="triggerClickEvent('intentDataInput')">Intent</button>
		</div>
	</div>
	
	<div id="utteranceArea" class="center">
		<div id="utteranceDataControlArea">
			<button onclick="addListItem()">Add</button>
			<button onclick="deleteAllItems()">Clear</button>
			<button onclick="triggerClickEvent('inputImport')">Import</button>
			<button onclick="exportUtteranceData()">Export</button>
		</div>
	
		<ol id="selectable">
		</ol>
	</div>
	
</body>

</html>
