<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Utterance Annotator</title>
	<link rel="stylesheet" href="utterance_annotator.css"/>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/themes/smoothness/jquery-ui.css"/>
	<link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
	<script src="https://cdn.rawgit.com/eligrey/Blob.js/0cef2746414269b16834878a8abc52eb9d53e6bd/Blob.js"></script>
	<script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
	<script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
	
	<script>
	var slotCandidates = {};
	var intentCandidates = {};
	
	var contextMenuForSlot = {
		items: slotCandidates,
		callback: function(itemKey, opt) {
			var input = opt.$trigger[0];
			var index = getSelectionStart(input);
			if (index > 0) {
				for (; index >= 0; --index) {
					if (input.value.charAt(index - 1) == ' ') {
						break;
					}
				}
			}
			
			var startIdx = -1, endIdx = -1;				
			for (; index < input.value.length; ++index) {
				if (input.value.charAt(index) == ' ' || input.value.charAt(index) == ')') {
					if (startIdx == -1) startIdx = index;
					endIdx = index;
					break;
				} else if (input.value.charAt(index) == '/') {
					startIdx = index;
				}
			}
			
			if (startIdx == -1) startIdx = index;
			if (endIdx == -1) endIdx = index;
			
			input.value = insertString(input.value, startIdx, endIdx, '/B-' + itemKey);
			input.oninput(input);

			return true;
		}
	};

	var contextMenuForIntent = {
		items: intentCandidates,
		callback: function(itemKey, opt) {
			var input = opt.$trigger[0];
			var text = input.value.substring(input.selectionStart, input.selectionEnd).trim();
			console.log(text);

			var domain;
			var keys = Object.keys(intentCandidates);
			for (var i = 0; i < keys.length; ++i) {
				if (intentCandidates[keys[i]]['items'][itemKey] != null) {
					domain = keys[i];
					break;
				}
			}
			
			console.log('domain:' + domain + ', intent:' + itemKey);
			input.value = insertString(input.value, input.selectionStart, input.selectionEnd, '(' + text + ')#' + domain + '%' + itemKey);
			input.oninput(input);
			
			return true;
		}
	};

	$(function() {
		$('#selectable').selectable({
			stop: function() {
				$('.ui-selected', this).each(function() {
					$('#inputRaw').val(this.children[0].innerText);
					$('#inputTagged').val(this.children[1].innerText);
				});
			}
		});
	});	

	$(function() {
        $.contextMenu({
            selector: '.context-menu-one',
			build: function($triggerElement, e) {
				var input = $triggerElement[0];
				var text = $triggerElement.val().substring(input.selectionStart, input.selectionEnd).trim();
				if (text == '') return contextMenuForSlot;
				else return contextMenuForIntent;
			},
        });
    });

	function insertString(text, headIdx, tailIdx, str) {
		var head = text.substring(0, headIdx);
		var tail = text.substring(tailIdx);
		return head + str + tail;
	};

	function onRawInputChanged(input) {
		$('#selectable .ui-selected')[0].children[0].innerText = input.value;
	}

	function onTaggedInputChanged(input) {
		$('#selectable .ui-selected')[0].children[1].innerText = input.value;
	}
	
	function onSlotFileUploaded(input) {
		var file = input.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
		  var dataList = reader.result.split("\n");
		  for (var i = 0; i < dataList.length; ++i ) {
			var text = dataList[i].trim();
			if (text == '') continue;

			slotCandidates[text] = { name: text };
		  }
 		  console.log(slotCandidates);
		  $('#slotDataLoadButton').removeClass('unsatisfied');
		  $('#slotDataLoadButton').addClass('satisfied');
		}

		reader.readAsText(file);
		input.value = null;
	}

	function onIntentFileUploaded(input) {
		var file = input.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
		  var dataList = reader.result.split("\n");
		  var domain;
		  for (var i = 0; i < dataList.length; ++i ) {
			var text = dataList[i].trim();
			if (text == '') continue;
			
			if (text.charAt(0) == '#') {
				domain = text.replace('#', '');
				intentCandidates[domain] = { 
					name: domain, 
					items: {}
				};
			} else if (domain != null) {
				intentCandidates[domain]['items'][text] = { name: text };
			}
		  }
 		  console.log(intentCandidates);
		  $('#intentDataLoadButton').removeClass('unsatisfied');
		  $('#intentDataLoadButton').addClass('satisfied');
		}

		reader.readAsText(file);
		input.value = null;
	}

	function getSelectionStart(input) {
		if (input.createTextRange) {
			var r = document.selection.createRange().duplicate();
			r.moveEnd('character', input.value.length);
			if (r.text == '') return input.value.length;
			return input.value.lastIndexOf(r.text);
		} else {
			return input.selectionStart;
		}
	}
	
	function addListItem(raw, tagged) {
		console.log(raw + ', ' + tagged);
		if (raw == null) raw = '';
		if (tagged == null) tagged = '';
		$('#selectable').append('<li class="ui-widget-content"><span class="list-item-raw">' + raw + '</span><span class="list-item-tagged">' + tagged + '</span></li>');
	}
	
	function deleteAllItems() {
		var result = window.confirm('Delete all data?');
		if (result) {
			$('#selectable li').remove();
			addListItem();
		}
	}

	function onUntteranceDataImported(input) {
		var file = input.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
		  var dataList = reader.result.split("\n");
		  var raw, tagged;
		  for (var i = 0; i < dataList.length; ++i ) {
			var text = dataList[i].trim();
			if (text == '') continue;			
			
			var texts = text.split(',');
			addListItem(texts[0], texts[1]);
		  }
		}

		reader.readAsText(file, 'euc-kr');
		input.value = null;
	}

	function exportUtteranceData() {
		var text = '';
		var items = $('#selectable')[0].children;
		for (var i = 0; i < items.length; ++i) {
			var raw = items[i].children[0].innerText;
			var tagged = items[i].children[1].innerText;
			if (raw != '' || tagged != '') {
				text += raw + ',' + tagged + '\n';
			}
		}
		
		var file = new File([text], '', { type: "text/plain;charset=utf-8" });
		saveAs(file, 'utterance_data.csv');
	}
	
	function triggerClickEvent(id) {
		$('#' + id)[0].click();
	}
	
	</script>
</head>

<body>
	<input type="file" class="hide" id="slotDataInput" onchange="onSlotFileUploaded(this)"/>
	<input type="file" class="hide" id="intentDataInput" onchange="onIntentFileUploaded(this)"/>
	<input type="file" class="hide" id="inputImport" onchange="onUntteranceDataImported(this)"/>

	<div id="headerArea" class="center">
		<h1 id="title">Utterance Annotator</h1>
		
		<div id="inputArea">
			<input type="text" id="inputRaw" oninput="onRawInputChanged(this)"/><br/>
			<input type="text" id="inputTagged" class="context-menu-one" oninput="onTaggedInputChanged(this)"/>

		</div>
		
		<div id="annotationDataControlArea">
			<button id="slotDataLoadButton" class="unsatisfied" onclick="triggerClickEvent('slotDataInput')">Slot</button>
			<button id="intentDataLoadButton" class="unsatisfied" onclick="triggerClickEvent('intentDataInput')">Intent</button>
		</div>
	</div>
	
	<div id="utteranceArea">
		<div id="dataControlArea">
			<button class="ui-button ui-widget ui-corner-all" onclick="addListItem()">Add</button>
			<button class="ui-button ui-widget ui-corner-all" onclick="deleteAllItems()">Clear</button>
			<button class="ui-button ui-widget ui-corner-all" onclick="triggerClickEvent('inputImport')">Import</button>
			<button class="ui-button ui-widget ui-corner-all" onclick="exportUtteranceData()">Export</button>
		</div>
	
		<ol id="selectable">
			<li class="ui-widget-content ui-selected"><span class="list-item-raw"></span><span class="list-item-tagged"></span></li>
		</ol>
	</div>
	
</body>

</html>
