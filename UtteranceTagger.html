<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Utterance Tagger</title>
	<link rel="stylesheet" href="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.css" type="text/css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js" type="text/javascript"></script>
	<script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.contextMenu.js" type="text/javascript"></script>
	<script src="https://swisnl.github.io/jQuery-contextMenu/dist/jquery.ui.position.min.js" type="text/javascript"></script>
	
	<script>
	var slotCandidates = {};
	var intentCandidates = {};
	
	var contextMenuForSlot = {
		items: slotCandidates,
		callback: function(itemKey, opt) {
			var input = document.getElementById("utterance");
			var index = getSelectionStart(input);
			if (index > 0) {
				for (; index >= 0; --index) {
					if (input.value.charAt(index - 1) == ' ') {
						break;
					}
				}
			}
			
			var startIdx = -1, endIdx = -1;				
			for (; index < input.value.length; ++index) {
				if (input.value.charAt(index) == ' ') {
					if (startIdx == -1) startIdx = index;
					endIdx = index;
					break;
				} else if (input.value.charAt(index) == '/') {
					startIdx = index;
				}
			}
			
			if (startIdx == -1) startIdx = index;
			if (endIdx == -1) endIdx = index;
			
			var output = insertString(input.value, startIdx, endIdx, '/I-' + itemKey);
			input.value = arrangeSlots(output);
			return true;
		}
	};

	var contextMenuForIntent = {
		items: intentCandidates,
		callback: function(itemKey, opt) {
			var input = document.getElementById("utterance");
			var text = input.value.substring(input.selectionStart, input.selectionEnd).trim();
			console.log(text);

			var domain;
			var keys = Object.keys(intentCandidates);
			for (var i = 0; i < keys.length; ++i) {
				if (intentCandidates[keys[i]]['items'][itemKey] != null) {
					domain = keys[i];
					break;
				}
			}
			
			console.log('domain:' + domain + ', intent:' + itemKey);
			input.value = insertString(input.value, input.selectionStart, input.selectionEnd, 
				'(' + text + ')#' + domain + '%' + itemKey);
			
			return true;
		}
	};

	$(function() {
        $.contextMenu({
            selector: '.context-menu-one',
			build: function($triggerElement, e) {
				var input = document.getElementById("utterance");
				var text = input.value.substring(input.selectionStart, input.selectionEnd).trim();
				if (text == '') return contextMenuForSlot;
				else return contextMenuForIntent;
			},
        });
    });

	function insertString(text, headIdx, tailIdx, str) {
		var head = text.substring(0, headIdx);
		var tail = text.substring(tailIdx);
		return head + str + tail;
	};

	function arrangeSlots(text) {
		var output = text.replace('/B-', '/I-');
		var idx = output.indexOf('/I-');
		if (idx > -1) {
			output = insertString(output, idx, idx + '/I-'.length, '/B-');
		}
		
		return output;
	}
	
	function onSlotFileUploaded(input) {
		var file = input.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
		  var dataList = reader.result.split("\n");
		  for (var i = 0; i < dataList.length; ++i ) {
			var text = dataList[i].trim();
			if (text == '') continue;

			slotCandidates[text] = { name: text };
		  }
 		  console.log(slotCandidates);
		}

		reader.readAsText(file);
	}

	function onIntentFileUploaded(input) {
		var file = input.files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
		  var dataList = reader.result.split("\n");
		  var domain;
		  for (var i = 0; i < dataList.length; ++i ) {
			var text = dataList[i].trim();
			if (text == '') continue;
			
			if (text.charAt(0) == '#') {
				domain = text.replace('#', '');
				intentCandidates[domain] = { 
					name: domain, 
					items: {}
				};
			} else if (domain != null) {
				intentCandidates[domain]['items'][text] = { name: text };
			}
		  }
 		  console.log(intentCandidates);
		}

		reader.readAsText(file);
	}

	function getSelectionStart(input) {
		if (input.createTextRange) {
			var r = document.selection.createRange().duplicate();
			r.moveEnd('character', input.value.length);
			if (r.text == '') return input.value.length;
			return input.value.lastIndexOf(r.text);
		} else {
			return input.selectionStart;
		}
	}
	</script>
</head>

<body>
	<label for="utterance">Utterance
	<input type="text" id="utterance" class="context-menu-one" name="utterance" value="어제 찍은 사진 보내줘"><br/>
	<label for="slotDataInput">Slot
	<input type="file" id="slotDataInput" onchange="onSlotFileUploaded(this)"><br/>
	<label for="intentDataInput">Intent
	<input type="file" id="intentDataInput" onchange="onIntentFileUploaded(this)">
</body>

</html>
